{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    .main-img-style {
        max-height: 380px;
        max-width: 100%;
        width: auto;
        height: auto;
        object-fit: cover;
        border-radius: 0.75rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .main-img-style:hover {
        transform: scale(1.03);
    }

    .back-btn {
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        padding: 0.5rem 1.25rem;
    }

    @media (max-width: 768px) {
        .main-img-style {
            max-height: 260px;
        }
    }

    .gallery-thumb {
        transition: transform 0.2s ease;
    }

    .gallery-thumb:hover {
        transform: scale(1.05);
    }
</style>

<div class="container my-5">

    <!-- Back button -->
    <a href="javascript:history.back()" class="btn btn-outline-dark back-btn">
        ‚Üê Orqaga qaytish
    </a>

    <div class="card mb-4 shadow-sm border-0">
        <div class="row g-0">
            <!-- Main image -->
            <div class="col-md-5 d-flex align-items-center justify-content-center p-3">
                {% if product.images.all %}
                    <a href="#" data-bs-toggle="modal" data-bs-target="#galleryCarouselModal" data-index="0">
                        <img src="{{ product.images.all.0.image.url }}" class="main-img-style gallery-thumb" alt="{{ product.name }}">
                    </a>
                {% else %}
                    <img src="{% static 'default.jpg' %}" class="main-img-style" alt="No image available">
                {% endif %}
            </div>

            <!-- Product info -->
            <div class="col-md-7">
                <div class="card-body d-flex flex-column justify-content-center h-100 text-center">
                    <h3 class="card-title fw-semibold">{{ product.name }}</h3>
                    <p class="card-text text-muted">{{ product.description }}</p>
                    <a class="btn btn-dark mt-3" href="{% url 'qabristonmap' pk=product.pk %}">
                        Qabriston xaritasi
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Image gallery -->
    {% if product.images.all|length > 1 %}
    <div class="mb-5">
        <h5 class="mb-3">Rasmlar:</h5>
        <div class="d-flex flex-wrap gap-3">
            {% for image in product.images.all %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#galleryCarouselModal" data-index="{{ forloop.counter0 }}">
                    <img src="{{ image.image.url }}" width="140" height="140" class="img-thumbnail gallery-thumb" alt="Gallery image">
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Unified carousel modal -->
<div class="modal fade" id="galleryCarouselModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0">
        <div id="productImageCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for image in product.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ image.image.url }}" class="d-block w-100 rounded shadow-lg" alt="Gallery image">
              </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Oldingi</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Keyingi</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript to open carousel on clicked index -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const thumbs = document.querySelectorAll('[data-bs-target="#galleryCarouselModal"]');
    const carousel = document.getElementById('productImageCarousel');
    let carouselInstance;

    thumbs.forEach((thumb, index) => {
        thumb.addEventListener('click', function () {
            const targetIndex = parseInt(this.getAttribute('data-index'));
            setTimeout(() => {
                if (!carouselInstance) {
                    carouselInstance = bootstrap.Carousel.getInstance(carousel) || new bootstrap.Carousel(carousel);
                }
                carouselInstance.to(targetIndex);
            }, 300);
        });
    });
});
</script>

{% endblock %}
